{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-4 mb-5">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h4 class="mb-0">{% if edit_component %}Edit Component{% else %}Add Component{% endif %}</h4>
            </div>
            <div class="card-body">
                <form id="componentForm" action="/components" method="post">
                    {% if edit_component %}
                    <input type="hidden" name="component_id" value="{{ edit_component.id }}">
                    {% endif %}
                    <div class="mb-3">
                        <label for="name" class="form-label">Component Name</label>
                        <input type="text" class="form-control" id="name" name="name" required
                            value="{{ edit_component.name if edit_component else '' }}" placeholder="e.g. Compact Road">
                    </div>
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <select class="form-select" id="type" name="type" required>
                            <option value="Chainring" {% if edit_component and edit_component.type=='Chainring'
                                %}selected{% endif %}>Chainring</option>
                            <option value="Cassette" {% if edit_component and edit_component.type=='Cassette'
                                %}selected{% endif %}>Cassette</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="speed" class="form-label">Speed (Optional)</label>
                        <input type="number" class="form-control" id="speed" name="speed" step="1" min="1"
                            value="{{ edit_component.speed if edit_component and edit_component.speed else '' }}"
                            placeholder="e.g. 11">
                        <div class="form-text">Number of cogs/rings (e.g., 11 for 11-speed). If provided, must match the count of teeth values below.</div>
                    </div>
                    <div class="mb-3">
                        <label for="teeth" class="form-label">Teeth (Comma separated)</label>
                        <input type="text" class="form-control" id="teeth" name="teeth" required
                            value="{{ edit_component.teeth_str if edit_component else '' }}"
                            placeholder="e.g. 50, 34 or 11, 12, 13..."
                            pattern="^[0-9]+(,\s*[0-9]+)*$">
                        <div class="form-text">Enter whole numbers only (integers) for each cog/ring, separated by commas.</div>
                    </div>
                    <div class="mb-3">
                        <label for="comments" class="form-label">Comments</label>
                        <textarea class="form-control" id="comments" name="comments"
                            rows="3">{{ (edit_component.comments or '') if edit_component else '' }}</textarea>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">{% if edit_component %}Update Component{% else
                            %}Add Component{% endif %}</button>
                        {% if edit_component %}
                        <a href="/components" class="btn btn-outline-secondary">Cancel</a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <h2 class="mb-4">Existing Components</h2>

        <h4 class="border-bottom pb-2 mb-3">Chainrings</h4>
        <div class="row g-3 mb-5">
            {% for ring in chainrings %}
            <div class="col-md-6">
                <div class="card h-100 border-0">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0 fw-bold">{{ ring.name }}</h5>
                        </div>
                        <p class="card-text text-muted small mb-2">
                            <i class="bi bi-gear-fill me-1"></i> {{ ring.teeth }}T
                            {% if ring.speed %}<span class="ms-2 badge bg-secondary">{{ ring.speed }}-speed</span>{% endif %}
                        </p>
                        {% if ring.comments %}
                        <p class="card-text text-muted small mb-3 fst-italic">{{ ring.comments }}</p>
                        {% else %}
                        <div class="mb-3"></div>
                        {% endif %}

                        <div class="mt-auto d-flex gap-2">
                            <a href="/components/{{ ring.id }}"
                                class="btn btn-sm btn-outline-primary flex-grow-1">Edit</a>
                            <button onclick="deleteItem('/components/{{ ring.id }}')"
                                class="btn btn-sm btn-outline-danger flex-grow-1">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12">
                <div class="alert alert-light text-muted text-center">No chainrings found.</div>
            </div>
            {% endfor %}
        </div>

        <h4 class="border-bottom pb-2 mb-3">Cassettes</h4>
        <div class="row g-3">
            {% for cassette in cassettes %}
            <div class="col-md-6">
                <div class="card h-100 border-0">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0 fw-bold">{{ cassette.name }}</h5>
                        </div>
                        <p class="card-text text-muted small mb-2">
                            <i class="bi bi-gear-wide-connected me-1"></i> {{ cassette.teeth }}T
                            {% if cassette.speed %}<span class="ms-2 badge bg-secondary">{{ cassette.speed }}-speed</span>{% endif %}
                        </p>
                        {% if cassette.comments %}
                        <p class="card-text text-muted small mb-3 fst-italic">{{ cassette.comments }}</p>
                        {% else %}
                        <div class="mb-3"></div>
                        {% endif %}

                        <div class="mt-auto d-flex gap-2">
                            <a href="/components/{{ cassette.id }}"
                                class="btn btn-sm btn-outline-primary flex-grow-1">Edit</a>
                            <button onclick="deleteItem('/components/{{ cassette.id }}')"
                                class="btn btn-sm btn-outline-danger flex-grow-1">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12">
                <div class="alert alert-light text-muted text-center">No cassettes found.</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('componentForm');
    const speedInput = document.getElementById('speed');
    const teethInput = document.getElementById('teeth');

    form.addEventListener('submit', function(event) {
        const speedValue = speedInput.value.trim();
        const teethValue = teethInput.value.trim();

        // Only validate if speed is provided
        if (speedValue) {
            // Parse teeth string to count values
            const teethArray = teethValue.split(',').map(t => t.trim()).filter(t => t);
            const teethCount = teethArray.length;
            const speed = parseInt(speedValue);

            // Validate that all teeth values are integers
            const allIntegers = teethArray.every(t => /^\d+$/.test(t) && !t.includes('.'));

            if (!allIntegers) {
                event.preventDefault();
                alert('Teeth values must be whole numbers (integers) only, no decimals.');
                teethInput.focus();
                return false;
            }

            // Validate speed matches teeth count
            if (speed !== teethCount) {
                event.preventDefault();
                alert(`Speed value (${speed}) must match the number of teeth values (${teethCount}).\n\nYou entered ${teethCount} teeth values but specified ${speed}-speed.`);
                speedInput.focus();
                return false;
            }
        } else {
            // Even without speed, validate teeth are integers
            const teethArray = teethValue.split(',').map(t => t.trim()).filter(t => t);
            const allIntegers = teethArray.every(t => /^\d+$/.test(t) && !t.includes('.'));

            if (!allIntegers) {
                event.preventDefault();
                alert('Teeth values must be whole numbers (integers) only, no decimals.');
                teethInput.focus();
                return false;
            }
        }
    });
});
</script>
{% endblock %}